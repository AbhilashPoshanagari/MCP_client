import{$ as qe,$b as Z,A as ke,B as Ee,C as Ae,D as Ie,E as $e,F as Ne,G as v,H as ze,I as Ue,J as Be,Jb as H,K as Re,L as De,M as He,N as X,O as Y,Pb as W,Q as C,R as O,S as ce,T as me,U as M,V as We,W as Ge,X as N,Xb as he,Y as _,Yb as be,Z as z,_ as Je,_b as S,a as p,aa as U,ac as L,b as f,ba as B,c as pe,ca as Ke,da as Qe,e as Ve,ea as P,fa as R,fc as x,ga as Xe,gc as ee,h as c,ha as Ye,hc as k,ia as w,ic as d,ja as T,jc as G,ka as Ze,la as Le,ma as fe,qa as F,ra as et,sa as tt,ta as rt,ua as at,v as je,va as D,w as Ce,x as Oe,y as Fe,z as Se}from"./chunk-236BIZN3.js";var ut={};Ve(ut,{AIMessage:()=>M,AIMessageChunk:()=>N,BaseMessage:()=>v,BaseMessageChunk:()=>De,ChatMessage:()=>_,ChatMessageChunk:()=>z,FunctionMessage:()=>U,FunctionMessageChunk:()=>B,HumanMessage:()=>P,HumanMessageChunk:()=>R,RemoveMessage:()=>V,SystemMessage:()=>w,SystemMessageChunk:()=>T,ToolMessage:()=>C,ToolMessageChunk:()=>O,_isMessageFieldWithRole:()=>He,_mergeDicts:()=>Ue,_mergeLists:()=>Be,_mergeObj:()=>Re,_mergeStatus:()=>Ne,coerceMessageLikeToMessage:()=>F,convertToChunk:()=>D,convertToOpenAIImageBlock:()=>ke,convertToProviderContentBlock:()=>Ie,defaultTextSplitter:()=>ve,filterMessages:()=>st,getBufferString:()=>et,isAIMessage:()=>We,isAIMessageChunk:()=>Ge,isBase64ContentBlock:()=>Oe,isBaseMessage:()=>X,isBaseMessageChunk:()=>Y,isChatMessage:()=>Je,isChatMessageChunk:()=>qe,isDataContentBlock:()=>je,isFunctionMessage:()=>Ke,isFunctionMessageChunk:()=>Qe,isHumanMessage:()=>Xe,isHumanMessageChunk:()=>Ye,isIDContentBlock:()=>Se,isOpenAIToolCallArray:()=>ze,isPlainTextContentBlock:()=>Fe,isSystemMessage:()=>Ze,isSystemMessageChunk:()=>Le,isToolMessage:()=>ce,isToolMessageChunk:()=>me,isURLContentBlock:()=>Ce,mapChatMessagesToStoredMessages:()=>at,mapStoredMessageToChatMessage:()=>tt,mapStoredMessagesToChatMessages:()=>rt,mergeContent:()=>$e,mergeMessageRuns:()=>it,parseBase64DataUrl:()=>Ae,parseMimeType:()=>Ee,trimMessages:()=>nt});var V=class extends v{constructor(e){super(f(p({},e),{content:""})),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return f(p({},super._printableFields),{id:this.id})}};var J=(i,e)=>{let t=[...new Set(e?.map(r=>{if(typeof r=="string")return r;let s=new r({});if(!("getType"in s)||typeof s.getType!="function")throw new Error("Invalid type provided.");return s.getType()}))],a=i.getType();return t.some(r=>r===a)};function st(i,e){return Array.isArray(i)?ge(i,e):W.from(t=>ge(t,i))}function ge(i,e={}){let{includeNames:t,excludeNames:a,includeTypes:r,excludeTypes:s,includeIds:o,excludeIds:n}=e,u=[];for(let l of i)if(!(a&&l.name&&a.includes(l.name))){{if(s&&J(l,s))continue;if(n&&l.id&&n.includes(l.id))continue}r||o||t?(t&&l.name&&t.some(m=>m===l.name)||r&&J(l,r)||o&&l.id&&o.some(m=>m===l.id))&&u.push(l):u.push(l)}return u}function it(i){return Array.isArray(i)?de(i):W.from(de)}function de(i){if(!i.length)return[];let e=[];for(let t of i){let a=t,r=e.pop();if(!r)e.push(a);else if(a.getType()==="tool"||a.getType()!==r.getType())e.push(r,a);else{let s=D(r),o=D(a),n=s.concat(o);typeof s.content=="string"&&typeof o.content=="string"&&(n.content=`${s.content}
${o.content}`),e.push(lt(n))}}return e}function nt(i,e){if(Array.isArray(i)){let t=i;if(!e)throw new Error("Options parameter is required when providing messages.");return ye(t,e)}else{let t=i;return W.from(a=>ye(a,t)).withConfig({runName:"trim_messages"})}}function ye(i,e){return c(this,null,function*(){let{maxTokens:t,tokenCounter:a,strategy:r="last",allowPartial:s=!1,endOn:o,startOn:n,includeSystem:u=!1,textSplitter:l}=e;if(n&&r==="first")throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(u&&r==="first")throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let m;"getNumTokens"in a?m=h=>c(null,null,function*(){return(yield Promise.all(h.map(y=>a.getNumTokens(y.content)))).reduce((y,Q)=>y+Q,0)}):m=h=>c(null,null,function*(){return a(h)});let b=ve;if(l&&("splitText"in l?b=l.splitText:b=h=>c(null,null,function*(){return l(h)})),r==="first")return xe(i,{maxTokens:t,tokenCounter:m,textSplitter:b,partialStrategy:s?"first":void 0,endOn:o});if(r==="last")return ot(i,{maxTokens:t,tokenCounter:m,textSplitter:b,allowPartial:s,includeSystem:u,startOn:n,endOn:o});throw new Error(`Unrecognized strategy: '${r}'. Must be one of 'first' or 'last'.`)})}function xe(i,e){return c(this,null,function*(){let{maxTokens:t,tokenCounter:a,textSplitter:r,partialStrategy:s,endOn:o}=e,n=[...i],u=0;for(let l=0;l<n.length;l+=1){let m=l>0?n.slice(0,-l):n;if((yield a(m))<=t){u=n.length-l;break}}if(u<n.length-1&&s){let l=!1;if(Array.isArray(n[u].content)){let m=n[u];if(typeof m.content=="string")throw new Error("Expected content to be an array.");let b=m.content.length,h=s==="last"?[...m.content].reverse():m.content;for(let g=1;g<=b;g+=1){let y=s==="first"?h.slice(0,g):h.slice(-g),Q=Object.fromEntries(Object.entries(m).filter(([ue])=>ue!=="type"&&!ue.startsWith("lc_"))),Te=te(m.getType(),f(p({},Q),{content:y})),le=[...n.slice(0,u),Te];if((yield a(le))<=t)n=le,u+=1,l=!0;else break}l&&s==="last"&&(m.content=[...h].reverse())}if(!l){let m=n[u],b;if(Array.isArray(m.content)&&m.content.some(h=>typeof h=="string"||h.type==="text")?b=m.content.find(g=>g.type==="text"&&g.text)?.text:typeof m.content=="string"&&(b=m.content),b){let h=yield r(b),g=h.length;s==="last"&&h.reverse();for(let y=0;y<g-1;y+=1)if(h.pop(),m.content=h.join(""),(yield a([...n.slice(0,u),m]))<=t){s==="last"&&(m.content=[...h].reverse().join("")),n=[...n.slice(0,u),m],u+=1;break}}}}if(o){let l=Array.isArray(o)?o:[o];for(;u>0&&!J(n[u-1],l);)u-=1}return n.slice(0,u)})}function ot(i,e){return c(this,null,function*(){let m=e,{allowPartial:t=!1,includeSystem:a=!1,endOn:r,startOn:s}=m,o=pe(m,["allowPartial","includeSystem","endOn","startOn"]),n=i.map(b=>{let h=Object.fromEntries(Object.entries(b).filter(([g])=>g!=="type"&&!g.startsWith("lc_")));return te(b.getType(),h,Y(b))});if(r){let b=Array.isArray(r)?r:[r];for(;n.length>0&&!J(n[n.length-1],b);)n=n.slice(0,-1)}let u=a&&n[0]?.getType()==="system",l=u?n.slice(0,1).concat(n.slice(1).reverse()):n.reverse();return l=yield xe(l,f(p({},o),{partialStrategy:t?"last":void 0,endOn:s})),u?[l[0],...l.slice(1).reverse()]:l.reverse()})}var we={human:{message:P,messageChunk:R},ai:{message:M,messageChunk:N},system:{message:w,messageChunk:T},developer:{message:w,messageChunk:T},tool:{message:C,messageChunk:O},function:{message:U,messageChunk:B},generic:{message:_,messageChunk:z},remove:{message:V,messageChunk:V}};function te(i,e,t){let a,r;switch(i){case"human":t?a=new R(e):r=new P(e);break;case"ai":if(t){let s=p({},e);"tool_calls"in s&&(s=f(p({},s),{tool_call_chunks:s.tool_calls?.map(o=>f(p({},o),{type:"tool_call_chunk",index:void 0,args:JSON.stringify(o.args)}))})),a=new N(s)}else r=new M(e);break;case"system":t?a=new T(e):r=new w(e);break;case"developer":t?a=new T(f(p({},e),{additional_kwargs:f(p({},e.additional_kwargs),{__openai_role__:"developer"})})):r=new w(f(p({},e),{additional_kwargs:f(p({},e.additional_kwargs),{__openai_role__:"developer"})}));break;case"tool":if("tool_call_id"in e)t?a=new O(e):r=new C(e);else throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");break;case"function":if(t)a=new B(e);else{if(!e.name)throw new Error("FunctionMessage must have a 'name' field");r=new U(e)}break;case"generic":if("role"in e)t?a=new z(e):r=new _(e);else throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");break;default:throw new Error(`Unrecognized message type ${i}`)}if(t&&a)return a;if(r)return r;throw new Error(`Unrecognized message type ${i}`)}function lt(i){let e=i.getType(),t,a=Object.fromEntries(Object.entries(i).filter(([r])=>!["type","tool_call_chunks"].includes(r)&&!r.startsWith("lc_")));if(e in we&&(t=te(e,a)),!t)throw new Error(`Unrecognized message chunk class ${e}. Supported classes are ${Object.keys(we)}`);return t}function ve(i){let e=i.split(`
`);return Promise.resolve([...e.slice(0,-1).map(t=>`${t}
`),e[e.length-1]])}var j=class i extends G{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),k([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}partial(e){return c(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=f(p({},this),{inputVariables:t,partialVariables:a});return new i(r)})}format(e){return c(this,null,function*(){let t={};for(let[o,n]of Object.entries(this.template))typeof n=="string"?t[o]=x(n,this.templateFormat,e):t[o]=n;let a=e.url||t.url,r=e.detail||t.detail;if(!a)throw new Error("Must provide either an image URL.");if(typeof a!="string")throw new Error("url must be a string.");let s={url:a};return r&&(s.detail=r),s})}formatPromptValue(e){return c(this,null,function*(){let t=yield this.format(e);return new be(t)})}};var E=class extends H{static lc_name(){return"DictPromptTemplate"}constructor(e){let t=e.templateFormat??"f-string",a=re(e.template,t);super(p({inputVariables:a},e)),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","dict"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=t,this.inputVariables=a}format(e){return c(this,null,function*(){return ae(this.template,e,this.templateFormat)})}invoke(e){return c(this,null,function*(){return yield this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})})}};function re(i,e){let t=[];for(let a of Object.values(i))if(typeof a=="string")ee(a,e).forEach(r=>{r.type==="variable"&&t.push(r.name)});else if(Array.isArray(a))for(let r of a)typeof r=="string"?ee(r,e).forEach(s=>{s.type==="variable"&&t.push(s.name)}):typeof r=="object"&&t.push(...re(r,e));else typeof a=="object"&&a!==null&&t.push(...re(a,e));return Array.from(new Set(t))}function ae(i,e,t){let a={};for(let[r,s]of Object.entries(i))if(typeof s=="string")a[r]=x(s,t,e);else if(Array.isArray(s)){let o=[];for(let n of s)typeof n=="string"?o.push(x(n,t,e)):typeof n=="object"&&o.push(ae(n,e,t));a[r]=o}else typeof s=="object"&&s!==null?a[r]=ae(s,e,t):a[r]=s;return a}var A=class extends H{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}invoke(e,t){return c(this,null,function*(){return this._callWithConfig(a=>this.formatMessages(a),e,f(p({},t),{runType:"prompt"}))})}},q=class extends A{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}formatMessages(e){return c(this,null,function*(){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let r=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw r.name="InputFormatError",r}let a;try{Array.isArray(t)?a=t.map(F):a=[F(t)]}catch(r){let s=typeof t=="string"?t:JSON.stringify(t,null,2),o=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${s}`,`Additional message: ${r.message}`].join(`

`));throw o.name="InputFormatError",o.lc_error_code=r.lc_error_code,o}return a})}},se=class extends A{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}formatMessages(e){return c(this,null,function*(){return[yield this.format(e)]})}},I=class extends G{constructor(e){super(e)}format(e){return c(this,null,function*(){return(yield this.formatPromptValue(e)).toString()})}formatPromptValue(e){return c(this,null,function*(){let t=yield this.formatMessages(e);return new he(t)})}},ie=class extends se{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}format(e){return c(this,null,function*(){return new _(yield this.prompt.format(e),this.role)})}static fromTemplate(e,t,a){return new this(d.fromTemplate(e,{templateFormat:a?.templateFormat}),t)}};function pt(i){return i===null||typeof i!="object"||Array.isArray(i)?!1:Object.keys(i).length===1&&"text"in i&&typeof i.text=="string"}function ct(i){return i===null||typeof i!="object"||Array.isArray(i)?!1:"image_url"in i&&(typeof i.image_url=="string"||typeof i.image_url=="object"&&i.image_url!==null&&"url"in i.image_url&&typeof i.image_url.url=="string")}var $=class extends A{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let a=[];this.prompt.forEach(r=>{"inputVariables"in r&&(a=a.concat(r.inputVariables))}),this.inputVariables=a}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let a=t._messageClass();return new a({content:e})}else if(t.chatMessageClass){let a=t.chatMessageClass();return new a({content:e,role:this.getRoleFromMessageClass(a.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(d.fromTemplate(e,t));let a=[];for(let r of e)if(typeof r=="string")a.push(d.fromTemplate(r,t));else if(r!==null)if(pt(r)){let s="";typeof r.text=="string"&&(s=r.text??"");let o=f(p({},t),{additionalContentFields:r});a.push(d.fromTemplate(s,o))}else if(ct(r)){let s=r.image_url??"",o,n=[];if(typeof s=="string"){let u;t?.templateFormat==="mustache"?u=L(s):u=Z(s);let l=u.flatMap(m=>m.type==="variable"?[m.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${s}`);n=[l[0]]}else n=[];s={url:s},o=new j({template:s,inputVariables:n,templateFormat:t?.templateFormat,additionalContentFields:r})}else if(typeof s=="object"){if("url"in s){let u;t?.templateFormat==="mustache"?u=L(s.url):u=Z(s.url),n=u.flatMap(l=>l.type==="variable"?[l.name]:[])}else n=[];o=new j({template:s,inputVariables:n,templateFormat:t?.templateFormat,additionalContentFields:r})}else throw new Error("Invalid image template");a.push(o)}else typeof r=="object"&&a.push(new E({template:r,templateFormat:t?.templateFormat}));return new this({prompt:a,additionalOptions:t})}format(e){return c(this,null,function*(){if(this.prompt instanceof S){let t=yield this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let a of this.prompt){let r={};if(!("inputVariables"in a))throw new Error(`Prompt ${a} does not have inputVariables defined.`);for(let s of a.inputVariables)r||(r={[s]:e[s]}),r=f(p({},r),{[s]:e[s]});if(a instanceof S){let s=yield a.format(r),o;"additionalContentFields"in a&&(o=a.additionalContentFields),t.push(f(p({},o),{type:"text",text:s}))}else if(a instanceof j){let s=yield a.format(r),o;"additionalContentFields"in a&&(o=a.additionalContentFields),t.push(f(p({},o),{type:"image_url",image_url:s}))}else if(a instanceof E){let s=yield a.format(r),o;"additionalContentFields"in a&&(o=a.additionalContentFields),t.push(p(p({},o),s))}}return this.createMessage(t)}})}formatMessages(e){return c(this,null,function*(){return[yield this.format(e)]})}},K=class extends ${static _messageClass(){return P}static lc_name(){return"HumanMessagePromptTemplate"}},ne=class extends ${static _messageClass(){return M}static lc_name(){return"AIMessagePromptTemplate"}},oe=class extends ${static _messageClass(){return w}static lc_name(){return"SystemMessagePromptTemplate"}};function mt(i){return typeof i.formatMessages=="function"}function ft(i,e){if(mt(i)||X(i))return i;if(Array.isArray(i)&&i[0]==="placeholder"){let r=i[1];if(e?.templateFormat==="mustache"&&typeof r=="string"&&r.slice(0,2)==="{{"&&r.slice(-2)==="}}"){let s=r.slice(2,-2);return new q({variableName:s,optional:!0})}else if(typeof r=="string"&&r[0]==="{"&&r[r.length-1]==="}"){let s=r.slice(1,-1);return new q({variableName:s,optional:!0})}throw new Error(`Invalid placeholder template for format ${e?.templateFormat??'"f-string"'}: "${i[1]}". Expected a variable name surrounded by ${e?.templateFormat==="mustache"?"double":"single"} curly braces.`)}let t=F(i),a;if(typeof t.content=="string"?a=t.content:a=t.content.map(r=>"text"in r?f(p({},r),{text:r.text}):"image_url"in r?f(p({},r),{image_url:r.image_url}):r),t._getType()==="human")return K.fromTemplate(a,e);if(t._getType()==="ai")return ne.fromTemplate(a,e);if(t._getType()==="system")return oe.fromTemplate(a,e);if(_.isInstance(t))return ie.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function ht(i){return i.constructor.lc_name()==="MessagesPlaceholder"}var _e=class i extends I{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let n of this.promptMessages)if(!(n instanceof v))for(let u of n.inputVariables)t.add(u);let a=this.inputVariables,r=new Set(this.partialVariables?a.concat(Object.keys(this.partialVariables)):a),s=new Set([...r].filter(n=>!t.has(n)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are not used in any of the prompt messages.`);let o=new Set([...t].filter(n=>!r.has(n)));if(o.size>0)throw new Error(`Input variables \`${[...o]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}_parseImagePrompts(e,t){return c(this,null,function*(){if(typeof e.content=="string")return e;let a=yield Promise.all(e.content.map(r=>c(this,null,function*(){if(r.type!=="image_url")return r;let s="";typeof r.image_url=="string"?s=r.image_url:s=r.image_url.url;let n=yield d.fromTemplate(s,{templateFormat:this.templateFormat}).format(t);return typeof r.image_url!="string"&&"url"in r.image_url?r.image_url.url=n:r.image_url=n,r})));return e.content=a,e})}formatMessages(e){return c(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=[];for(let r of this.promptMessages)if(r instanceof v)a.push(yield this._parseImagePrompts(r,t));else{let s=r.inputVariables.reduce((n,u)=>{if(!(u in t)&&!(ht(r)&&r.optional))throw fe(new Error(`Missing value for input variable \`${u.toString()}\``),"INVALID_PROMPT_INPUT");return n[u]=t[u],n},{}),o=yield r.formatMessages(s);a=a.concat(o)}return a})}partial(e){return c(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=f(p({},this),{inputVariables:t,partialVariables:a});return new i(r)})}static fromTemplate(e,t){let a=d.fromTemplate(e,t),r=new K({prompt:a});return this.fromMessages([r])}static fromMessages(e,t){let a=e.reduce((o,n)=>o.concat(n instanceof i?n.promptMessages:[ft(n,t)]),[]),r=e.reduce((o,n)=>n instanceof i?Object.assign(o,n.partialVariables):o,Object.create(null)),s=new Set;for(let o of a)if(!(o instanceof v))for(let n of o.inputVariables)n in r||s.add(n);return new this(f(p({},t),{inputVariables:[...s],promptMessages:a,partialVariables:r,templateFormat:t?.templateFormat}))}static fromPromptMessages(e){return this.fromMessages(e)}};var Me=class i extends S{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),k(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}getExamples(e){return c(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")})}partial(e){return c(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=f(p({},this),{inputVariables:t,partialVariables:a});return new i(r)})}format(e){return c(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t),r=yield Promise.all(a.map(o=>this.examplePrompt.format(o))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return x(s,this.templateFormat,t)})}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static deserialize(e){return c(this,null,function*(){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let a=yield d.deserialize(t),r;if(Array.isArray(e.examples))r=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new i({inputVariables:e.input_variables,examplePrompt:a,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})})}},Pe=class i extends I{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),k(this.prefix+this.suffix,this.templateFormat,t)}}getExamples(e){return c(this,null,function*(){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")})}formatMessages(e){return c(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t);a=a.map(s=>{let o={};return this.examplePrompt.inputVariables.forEach(n=>{o[n]=s[n]}),o});let r=[];for(let s of a){let o=yield this.examplePrompt.formatMessages(s);r.push(...o)}return r})}format(e){return c(this,null,function*(){let t=yield this.mergePartialAndUserVariables(e),a=yield this.getExamples(t),s=(yield Promise.all(a.map(n=>this.examplePrompt.formatMessages(n)))).flat().map(n=>n.content),o=[this.prefix,...s,this.suffix].join(this.exampleSeparator);return x(o,this.templateFormat,t)})}partial(e){return c(this,null,function*(){let t=this.inputVariables.filter(s=>!(s in e)),a=p(p({},this.partialVariables??{}),e),r=f(p({},this),{inputVariables:t,partialVariables:a});return new i(r)})}};export{ut as a,j as b,E as c,A as d,q as e,se as f,I as g,ie as h,K as i,ne as j,oe as k,_e as l,Me as m,Pe as n};
